
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZidanCoder — مولد كود (ملف واحد)</title>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet" />
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--accent:#0b63ff;--muted:#666;}
    body{font-family: "Segoe UI", Tahoma, Arial; background:var(--bg); margin:0; padding:18px; color:#111;}
    .wrap{max-width:1100px;margin:12px auto;}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(12,20,40,0.06);}
    h1{margin:0 0 8px;font-size:20px}
    label{display:block;margin-top:12px;font-weight:600}
    select, textarea, input[type=text] { width:100%; padding:10px; border-radius:8px; border:1px solid #e0e6f0; box-sizing:border-box; margin-top:6px; }
    .row{display:flex;gap:12px}
    .col{flex:1}
    button{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    pre{padding:12px;border-radius:8px;background:#2d2d2d;color:#eee;overflow:auto;max-height:360px}
    .meta{display:flex;gap:8px;align-items:center;margin-top:10px}
    .small{font-size:13px;color:#444}
    .mode-toggle{display:flex;gap:8px;margin-top:8px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #ddd;cursor:pointer}
    .pill.active{background:var(--accent);color:white;border-color:var(--accent)}
    .foot{font-size:13px;color:#666;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>بص يا زميلي — ZidanCoder (ملف واحد)</h1>
      <div class="muted">مولد قوالب كود وشرح. يعمل محليًا بدون خادم. لديك خيار الاتصال بـ LLM لو حطيت المفتاح بنفسك (تحذير أمني داخل الملف).</div>

      <label>الوضع</label>
      <div class="mode-toggle" id="modeToggle">
        <div class="pill active" data-mode="local">Local (بدون API)</div>
        <div class="pill" data-mode="llm">LLM (استخدام OpenAI — اختياري)</div>
      </div>

      <div id="llmBox" style="display:none;margin-top:10px">
        <label>OpenAI API Key (اختياري — لا تضعه هنا في إنتاج)</label>
        <input id="apiKey" type="text" placeholder="sk-..." />
        <div class="muted">تحذير: وضع المفتاح داخل هذا الملف يعرضه لأي شخص يملك الملف. الأفضل وضع مفتاح في خادم.</div>
      </div>

      <label>اختر اللغة</label>
      <select id="language">
        <option>Python</option>
        <option>JavaScript</option>
        <option>Java</option>
        <option>C#</option>
        <option>Go</option>
        <option>PHP</option>
        <option>Ruby</option>
        <option>Rust</option>
        <option>HTML/CSS/JS</option>
      </select>

      <label>وصف المطلوب (اكتب المطلوب بدقة)</label>
      <textarea id="prompt" rows="4" placeholder="مثال: دالة تقرأ ملف CSV وتحسب متوسط كل عمود وتطبع النتائج"></textarea>

      <div class="row" style="margin-top:10px">
        <div class="col"><button id="generate">توليد &amp; تحليل</button></div>
        <div class="col small">الوضع الافتراضي يولّد قالبًا آمنًا محليًا. إذا وضعت API Key ويُختار وضع LLM، سيحاول الاتصال بالنموذج للحصول على كود مفصّل.</div>
      </div>

      <hr />

      <div class="grid">
        <div>
          <h3>الكود الناتج</h3>
          <pre id="codeBlock" class="language-javascript"><code id="codeOutput" class="language-javascript">لم يتم التوليد بعد.</code></pre>
        </div>

        <div>
          <h3>الشرح و التحليل</h3>
          <div id="analysis" style="white-space:pre-wrap; background:#fafafa;padding:12px;border-radius:8px;min-height:200px;border:1px solid #eee;color:#111">
            لا يوجد شرح بعد.
          </div>
          <h4 style="margin-top:10px">تحذيرات</h4>
          <div id="warnings" class="small">-</div>
        </div>
      </div>

      <div class="meta">
        <button id="copyBtn">نسخ الكود</button>
        <button id="downloadBtn">تحميل كملف</button>
        <div class="small" id="status"></div>
      </div>

      <div class="foot">
        ملاحظة أمان: لا تشغّل أي كود يخالطه أوامر نظام على جهازك أو السيرفر مباشرة دون مراجعة. وضع API Key في ملف HTML مكشوف — استخدم خادم وسيط في الإنتاج.
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
  <script>
    // --- State ---
    const modeToggle = document.getElementById('modeToggle');
    const pills = Array.from(modeToggle.querySelectorAll('.pill'));
    let mode = 'local';
    const llmBox = document.getElementById('llmBox');
    const apiKeyInput = document.getElementById('apiKey');

    pills.forEach(p => p.addEventListener('click', () => {
      pills.forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      mode = p.getAttribute('data-mode');
      llmBox.style.display = (mode === 'llm') ? 'block' : 'none';
    }));

    // --- Elements ---
    const generateBtn = document.getElementById('generate');
    const languageEl = document.getElementById('language');
    const promptEl = document.getElementById('prompt');
    const codeOutput = document.getElementById('codeOutput');
    const codeBlock = document.getElementById('codeBlock');
    const analysis = document.getElementById('analysis');
    const warnings = document.getElementById('warnings');
    const status = document.getElementById('status');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    // --- Local template generator (safe) ---
    function generateLocalTemplate(lang, description) {
      description = description || 'task';
      const dEsc = description.replace(/"/g, '\\"');

      const templates = {
        "Python": {
          code:
`# Python - مثال مُولّد (ZidanCoder)
# ${description}
def main():
    # اكتب هنا منطق التنفيذ: هذا قالب بدئي
    print("تشغيل المهمة: ${dEsc}")

if __name__ == "__main__":
    main()
`,
          explanation: `ما يفعله الكود:
1. يُعرّف دالة main تحوي منطق المهمة.
2. يطبع سطرًا يدل على تشغيل المهمة.
3. السطر if __name__ == "__main__": يضمن تشغيل main عند تنفيذ الملف مباشرة.`
        },
        "JavaScript": {
          code:
`// JavaScript (Node.js) - قالب مبدئي
// ${description}
function main() {
  // ضع منطقك هنا
  console.log("تشغيل المهمة: ${dEsc}");
}

main();
`,
          explanation: `شرح:
1. دالة main تحتوي منطق المهمة.
2. console.log يطبع إخراجًا لتأكيد التشغيل.
3. يتم استدعاء main() لتشغيل الوظيفة.`
        },
        "Java": {
          code:
`// Java - قالب مبدئي
// ${description}
public class ZidanTask {
    public static void main(String[] args) {
        System.out.println("تشغيل المهمة: ${dEsc}");
        // أضف المنطق هنا
    }
}
`,
          explanation: `شرح:
1. فصل ZidanTask مع دالة main كنقطة دخول.
2. System.out.println يعرض إخراجًا، ضع منطقك تحت التعليق.`
        },
        "C#": {
          code:
`// C# - قالب مبدئي
// ${description}
using System;
class Zidan {
  static void Main() {
    Console.WriteLine("تشغيل المهمة: ${dEsc}");
    // منطقك هنا
  }
}
`,
          explanation: `شرح مماثل لـ Java: نقطة دخول Main وطباعة لإظهار التشغيل.`
        },
        "Go": {
          code:
`// Go - قالب مبدئي
// ${description}
package main
import "fmt"
func main() {
    fmt.Println("تشغيل المهمة: ${dEsc}")
    // المنطق هنا
}
`,
          explanation: `شرح:
دالة main في Go هي نقطة الدخول. fmt.Println لعرض النص.`
        },
        "PHP": {
          code:
`<?php
// PHP - قالب مبدئي
// ${description}
echo "تشغيل المهمة: ${dEsc}\\n";
// ضع منطق المعالجة هنا
?>`,
          explanation: `شرح:
يستخدم echo لعرض النص. هذا ملف PHP بسيط يعمل على خادم يدعم PHP.`
        },
        "Ruby": {
          code:
`# Ruby - قالب مبدئي
# ${description}
def main
  puts "تشغيل المهمة: ${dEsc}"
  # المنطق هنا
end

main
`,
          explanation: `شرح: دالة main ثم استدعاؤها؛ puts لعرض النص.`
        },
        "Rust": {
          code:
`// Rust - قالب مبدئي
// ${description}
fn main() {
    println!("تشغيل المهمة: ${dEsc}");
    // المنطق هنا
}
`,
          explanation: `شرح: fn main() هي نقطة الدخول، println! لعرض نص.`
        },
        "HTML/CSS/JS": {
          code:
`<!-- صفحة HTML بسيطة لتنفيذ مهمة في المتصفح -->
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Task</title></head>
<body>
  <h3>تشغيل المهمة: ${dEsc}</h3>
  <script>
    // ضع منطق JavaScript هنا
    console.log("تشغيل المهمة: ${dEsc}");
  </script>
</body>
</html>`,
          explanation: `شرح: صفحة HTML تعرض عنوانًا وتطبع في Console. يمكنك تعديل الجزء داخل <script>.`
        }
      };

      return templates[lang] || { code: "// لا يوجد قالب لهذه اللغة", explanation: "لا يوجد شرح" };
    }

    // --- Simple analyzer for local templates (heuristic) ---
    function analyzeLocal(lang, code, prompt) {
      const warningsList = [];
      if (prompt.toLowerCase().includes('file') || prompt.toLowerCase().includes('open')) {
        warningsList.push('تحذير: إذا تضمن الكود عمليات قراءة/كتابة على الملفات، تأكد من صلاحيات المسار ومعالجة الأخطاء.');
      }
      if (/exec|system|spawn|child_process/.test(code) && lang !== 'HTML/CSS/JS') {
        warningsList.push('تحذير: يحتوي الكود على نداءات لنظام التشغيل — راجعه قبل التشغيل.');
      }
      const complexity = (code.split('\n').length < 10) ? 'بسيط' : 'متوسط';
      return {
        explanation: `${analyzeIntro(lang, prompt)}\n\n${codeToExplanation(code)}`,
        warnings: warningsList,
        complexity
      };
    }

    function analyzeIntro(lang, prompt) {
      return `تحليل مُولد محليًا:
- اللغة: ${lang}
- المطلوب: ${prompt || '-'}
`;
    }

    function codeToExplanation(code) {
      // بسيط: شرح يعتمد على قوالب ثابتة (يمكن تطويرها لاحقًا)
      return `هذا قالب أساسى يُظهر بنية عامة للبرنامج. راجع الأماكن المعلّمة بالتعليقات لاضافة المنطق المطلوب.`;
    }

    // --- LLM call (optional) ---
    async function callOpenAI(apiKey, model, promptText) {
      // Note: uses OpenAI chat completions endpoint. لا تضع مفتاح في إنتاج.
      const url = 'https://api.openai.com/v1/chat/completions';
      const body = {
        model: model || 'gpt-4o',
        messages: [
          { role: 'system', content: 'You are a helpful assistant that returns JSON with keys: code, explanation, warnings (array), complexity.' },
          { role: 'user', content: promptText }
        ],
        temperature: 0.15,
        max_tokens: 1200
      };
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
        body: JSON.stringify(body)
      });
      if(!resp.ok){
        const t = await resp.text();
        throw new Error('LLM request failed: ' + resp.status + ' - ' + t);
      }
      const data = await resp.json();
      const text = data.choices?.[0]?.message?.content || '';
      // محاولة تحليل JSON من النص
      try {
        return JSON.parse(text);
      } catch (e) {
        // إذا لم يكن JSON، نضعه كـ explanation مع فصل قسم الكود إن وُجد
        return { code: text, explanation: 'LLM returned non-JSON text. See output.', warnings: [], complexity: 'unknown' };
      }
    }

    // --- Handlers ---
    generateBtn.addEventListener('click', async () => {
      generateBtn.disabled = true;
      generateBtn.textContent = 'جاري التوليد...';
      status.textContent = '';
      warnings.textContent = '-';
      try {
        const lang = languageEl.value;
        const prompt = promptEl.value.trim() || '(بدون وصف)';
        if (mode === 'local') {
          const tpl = generateLocalTemplate(lang, prompt);
          codeOutput.textContent = tpl.code;
          Prism.highlightElement(codeOutput);
          const analysisRes = analyzeLocal(lang, tpl.code, prompt);
          analysis.textContent = tpl.explanation + "\n\n" + analysisRes.explanation + `\n\nتقدير التعقيد: ${analysisRes.complexity}`;
          warnings.textContent = analysisRes.warnings.length ? analysisRes.warnings.join(' | ') : 'لا يوجد تحذيرات.';
          status.textContent = 'تم التوليد محليًا';
        } else {
          const key = apiKeyInput.value.trim();
          if (!key) {
            alert('حط الـ API Key عشان تستخدم وضع LLM.');
            return;
          }
          // بناء الـ prompt الموجّه للنموذج
          const userPrompt = `Language: ${lang}\nTask: ${prompt}\nReturn JSON with keys: code (string), explanation (string), warnings (array), complexity (string).`;
          status.textContent = 'اتصال بالنموذج...';
          try {
            const out = await callOpenAI(key, 'gpt-4o', userPrompt);
            codeOutput.textContent = out.code || '// لم يُرجع الكود';
            Prism.highlightElement(codeOutput);
            analysis.textContent = out.explanation || 'لا يوجد شرح';
            warnings.textContent = (out.warnings && out.warnings.length) ? out.warnings.join(' | ') : 'لا يوجد تحذيرات.';
            status.textContent = 'تم التوليد عبر LLM';
          } catch (err) {
            console.error(err);
            alert('فشل اتصال LLM: ' + err.message);
            status.textContent = 'فشل LLM';
          }
        }
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'توليد & تحليل';
      }
    });

    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(codeOutput.textContent).then(()=> {
        status.textContent = 'تم نسخ الكود للحافظة';
        setTimeout(()=> status.textContent = '', 2500);
      });
    });

    downloadBtn.addEventListener('click', () => {
      // اسم الملف مبني على اللغة
      const lang = languageEl.value.replace(/[^a-z0-9]/ig,'').toLowerCase();
      const extMap = { python: 'py', javascript: 'js', java: 'java', c: 'txt', csharp: 'cs', go: 'go', php: 'php', ruby: 'rb', rust: 'rs', htmlcssjs: 'html' };
      const ext = extMap[lang] || 'txt';
      const filename = `zidancoder_${lang || 'code'}.${ext}`;
      const blob = new Blob([codeOutput.textContent], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
    });

    // Syntax highlighting language class sync
    languageEl.addEventListener('change', () => {
      const lang = languageEl.value.toLowerCase();
      let cls = 'language-javascript';
      if (lang.includes('python')) cls = 'language-python';
      else if (lang.includes('java') && !lang.includes('javascript')) cls = 'language-java';
      else if (lang.includes('javascript')) cls = 'language-javascript';
      else if (lang.includes('php')) cls = 'language-php';
      else if (lang.includes('ruby')) cls = 'language-ruby';
      else if (lang.includes('rust')) cls = 'language-rust';
      else if (lang.includes('go')) cls = 'language-go';
      else if (lang.includes('html')) cls = 'language-markup';
      codeBlock.className = cls;
      codeOutput.className = cls;
      Prism.highlightElement(codeOutput);
    });

    // init
    languageEl.dispatchEvent(new Event('change'));
  </script>
</body>
</html>
